---
title: "Análise de Expressão Diferencial"
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
    theme: spacelab
    number_sections: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---
<style>
  body {text-align:justify}
</style>


### Explicação dos dados, sua origem e relevância

O trabalho utiliza dados de um estudo do The Cancer Genome Atlas (TCGA) relacionado com adenocarcinoma do pulmão, disponibilizados através do Genomic Data Commons (GDC). A decisão de utilizar os dados do GDC foi influenciada pela sua curadoria completa, que inclui diversas amostras e dados clínicos sólidos. Adicionalmente, a existência de documentação e pacotes R para interface com a API GDC foram também fatores decisivos para esta escolha para análise de expressão diferencial utilizando edgeR.

### Tarefas de preparação e de pré-processamento dos dados

#### Instalação e carregamento dos packages necessários

Em primeiro lugar, procedemos à instalação dos packages necessários para realizar a análise da expressão diferencial.

```{r}

  ## edgeR

#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")

#BiocManager::install("edgeR")


  ## limma 

#BiocManager::install("limma")


  ## Glimma

#BiocManager::install(c("Glimma"))


  ##gplots

#BiocManager::install(c("gplots"))


  ##org.Mm.eg.db

#BiocManager::install(c("org.Mm.eg.db"))


  ##RColorBrewer

#BiocManager::install(c("RColorBrewer"))


  ##TCGAbiolinks

#if (!requireNamespace("TCGAbiolinks", quietly = TRUE))
#  BiocManager::install("TCGAbiolinks")

  ##DESeq2

#BiocManager::install("DESeq2")


```

De seguida, foi efetuado o carregamento das bibliotecas que haviam sido instaladas.

```{r}
suppressMessages({
  library(edgeR)
  library(limma)
  library(Glimma)
  library(gplots)
  library(org.Mm.eg.db)
  library(RColorBrewer)
  library(TCGAbiolinks)
  library(SummarizedExperiment)
})

```

#### Transferência e carregamento dos ficheiros necessários

-   Transferência dos ficheiros de expressão genética associados ao dataset e geração de um objeto `summarizedExperiment`

Para a transferência do dataset do conjunto de dados de expressão genética, utilizou-se o pacote TCGAbiolinks, que é uma ferramenta que permite aceder e descarregar dados do The Cancer Genome Atlas (TCGA). Na query, definimos a procura específica dos dados do projeto TCGA-LUAD, a categoria dos mesmos é do tipo "Perfil do Transcriptoma" e a estratégia experimental utilizada para gerar esses dados é a RNA-Seq. Os dados foram processados utilizando o algoritmo STAR para alinhamento de sequências, resultando em contagens de leitura para cada gene. Portanto, o parâmetro "workflow.type" foi especificado como "STAR - Counts". Por fim, especificamos que queremos ter acesso aos dados que estão disponíveis publicamente através do parâmetro "access".

Após a transferência dos dados é então gerado um objeto `summarizedExperiment` através do código GDCprepare. Utilizam-se parâmetros para gravar os dados para simplificar o carregamento do objeto posteriormente, caso seja necessário.

```{r}

luad = GDCquery( 
  project = "TCGA-LUAD",
  data.category = "Transcriptome Profiling",
  experimental.strategy = 'RNA-Seq',
  workflow.type = "STAR - Counts",
  access = "open"
)

# GDCdownload(luad)

# Carregamos os dados de expressão genética e dos metadados associados

# luad_data = GDCprepare(luad, 
#                       save = TRUE, 
#                       save.filename = 'luad_data_load.rda',
#                       summarizedExperiment = TRUE)

# Simplificado
luad_data = GDCprepare(luad)

# Alternativamente
# load('luad_data_load.rda')

```

Abaixo procedemos a uma primeira verificação dos dados.

```{r}
# Tamanho do objeto
dim(luad_data)

# Informação sobre o estudo
metadata(luad_data)

# Informação sobre os dados de RNASeq
assays(luad_data)

# Tipos de assays
names(assays(luad_data))

#Tipos de metadados associados a cada gene
names(rowData(luad_data))

#Tipos de metadados associados a cada amostra
names(colData(luad_data))

```

Através da informação fornecida em cima, conseguimos perceber que:

-   **dim** - O objeto tem 60660 linhas, cada uma representa um gene, e 600 colunas, que representam as amostras individuais, correspondendo ao especificado na [documentação do estudo](https://portal.gdc.cancer.gov/projects/TCGA-LUAD)..

-   **metadata** - Os metadados indicam a data de lançamento dos dados .

-   **assays** - Parecem refletir diferentes formas de processamento ou normalização dos dados obtidos.

-   **rownames** - Cada linha está rotulada com o ID de um gene no formato Ensembl.

-   **rowData names** - Existem 10 metadados associados a cada gene, incluindo, por exemplo, a "source", o "type" e o "score".

-   **colnames** - As colunas estão rotuladas com os códigos de barras (barcodes) das amostras, identificando cada amostra de forma única.

-   **colData names** - Há 89 metadados associados a cada amostra, que incluem, por exemplo, o estágio do tumor ("paper_Tumor.stage") e o género ("gender").

#### Preparação dos dados

Para chegar à estrutura desejável dos dados, realizou-se a transformação do dataset em dataframe a partir dos dados em bruto. Optou-se por extrair os dados de RNASeq correspondentes às contagens `unstranded` por ser geralmente considerado uma boa prática.

Foram também carregados os metadados, isolando os dados correspondentes ao estágio do tumor de modo a poder fazer uma análise comparativa entre os

```{r}

# Carregamento, extração e transformação dos dados provenientes do RNAseq 
seqdata = as.data.frame(assay(luad_data, 'unstranded'))
any(is.na(seqdata))

# Carregamento de metadados

tumor_stage = luad_data$paper_Tumor.stage
gender = luad_data$gender
sample_id = luad_data$patient

meta = data.frame(sample_id = sample_id , gender = gender, tumor_stage = tumor_stage)

# Limpeza de dados baseados no sstadio do tumor

any(is.na(meta$tumor_stage))

meta = meta[!is.na(meta$tumor_stage),]

table(meta$tumor_stage)

filter = meta$tumor_stage != '[Not Available]'

meta = meta[filter,]

seqdata
meta
```

De seguida, foi feita uma filtração das colunas do dataframe `seqdata` para manter apenas as amostras que possuem informações sobre o estadio do tumor com base nos metadados previamente tratados.

O resultado é armazenado na variável `seqdata_filter`, que conterá apenas as colunas de `seqdata` associadas a amostras com informações sobre o estágio do tumor. Esta variável servirá para, posteriormente, criar o objeto de análise de expressão genética.

```{r}

# Criar uma vista dos dados de RNASeq com base no estadio do tumor

seqdata_filter = seqdata[,meta$tumor_stage] 


```

Fazemos uma verificação final para garantir que os dados estão corretamente carregados e é feita a sua correspondência.

```{r}
# Garantir que as dims estão corretas
dim(seqdata_filter)
dim(meta)

# Corrigir nomes e garantir ordem 
# A nomenclatura original tinha extra carateres nos colnames dos dados de epressao

colnames(seqdata_filter) = meta$sample_id
all(names(seqdata_filter) == meta$sample_id)

```
## Análise exploratória

Neste processo, os dados de expressão genética são refinados antes da análise. Primeiro, é efetuado o cálculo das Contagens Por Milhão (CPM), uma métrica importante na normalização de dados de sequenciamento. Em seguida, os dados são ajustados para remover genes com expressão muito baixa, uma prática comum na análise de RNA-Seq. Este critério de remoção, definido como genes com CPM inferior a 0.5 em pelo menos duas amostras, é aplicado para manter apenas os genes mais relevantes. O número de genes excluídos é relatado para avaliação. Posteriormente, os dados são organizados em um objeto `dgeObj`, adequado para análise estatística de expressão diferencial, preparando-os para investigações mais aprofundadas sobre as variações na expressão genética entre as condições estudadas (estadio do tumor).

A analisar o sumário da variável `keep`, que corresponde aos genes que serão mantidos para análise, identificamos que serão desconsiderados **36.135** genes.

```{r}
# Calculamos CPM
calccpm = cpm(seqdata_filter)

# Aparamos os dados, removendo genes com baixa expressão
# é geralmente aceite a eliminação de genes com CPM inferior a 0.5 em mais do que 2 amostras
thresh = calccpm > 0.5
keep = rowSums(thresh) >= 2
counts.keep = seqdata_filter[keep,]
summary(keep)
dim(counts.keep)
```

```{r}
# Criação do objeto para a análise de expr. diferencial
dgeObj = DGEList(counts.keep)
names(dgeObj)
head(dgeObj$samples)
```

A presença de outliers nos boxplots pode indicar a existência de genes sobreexpressos ou subexpressos em relação à maioria dos outros genes. Esses outliers representam observações que estão significativamente distantes da maioria dos valores no conjunto de dados. No contexto da expressão gênica, os outliers podem surgir devido a vários fatores, como erros experimentais, variações biológicas extremas ou mesmo artefatos técnicos durante a geração dos dados. Genes sobreexpressos, em particular, podem ser de interesse em estudos de expressão diferencial, uma vez que podem desempenhar papéis importantes em processos biológicos específicos ou estar associados a doenças. Portanto, a identificação e o entendimento dos outliers são cruciais para interpretar corretamente os resultados das análises de expressão gênica e para discernir padrões biologicamente relevantes das variações aleatórias nos dados.

```{r}
## distributions - log transform
logcounts <- cpm(dgeObj,log=TRUE)

boxplot(logcounts[,1:50], xlab="", ylab="Log2 counts per million",las=2)
abline(h=median(logcounts),col="blue")
title("Boxplots of logCPMs (unnormalised)")

boxplot(logcounts[,51:100], xlab="", ylab="Log2 counts per million",las=2)
abline(h=median(logcounts),col="blue")
title("Boxplots of logCPMs (unnormalised)")


boxplot(logcounts[,101:150], xlab="", ylab="Log2 counts per million",las=2)
abline(h=median(logcounts),col="blue")
title("Boxplots of logCPMs (unnormalised)")


boxplot(logcounts[,151:200], xlab="", ylab="Log2 counts per million",las=2)
abline(h=median(logcounts),col="blue")
title("Boxplots of logCPMs (unnormalised)")

boxplot(logcounts[,201:242], xlab="", ylab="Log2 counts per million",las=2)
abline(h=median(logcounts),col="blue")
title("Boxplots of logCPMs (unnormalised)")


```
Abaixo é feita a análise de expressão genética dos 500 genes com maior variabilidade detetada para os diferentes estadios do adenocarcinoma do pulmão (I a IV) Apesar do desafio imposto pelo grande número de amostras, esta análise exploratória revela diferenças notáveis entre estadios. 

Para melhorar a visualizaçõ destas diferenças poderão ser empregues estratégias como a análise de PCA ou a agregação de amostras , permitindo uma compreensão mais clara das variações genéticas associadas aos estadios tumorais. 

A identificação dos genes mais variáveis e a atribuição de cores com base nos estágios do tumor oferecem insights valiosos sobre a expressão genética diferencial entre os estadios do câncer, fornecendo pistas importantes sobre a progressão da doença e possíveis alvos terapêuticos.


```{r}
## heatmaps
var_genes <- apply(logcounts, 1, var)
#head(var_genes)
select_var <- names(sort(var_genes, decreasing=TRUE))[1:500]
#head(select_var)
highly_variable_lcpm <- logcounts[select_var,]
dim(highly_variable_lcpm)
#head(highly_variable_lcpm)
mypalette <- brewer.pal(11,"Pastel1")
morecols <- colorRampPalette(mypalette)

indices = 1:242
unique_stages = unique(meta$tumor_stage[indices])

cores = length(unique_stages)
stage_pal = brewer.pal(9,'Set1')
stage_cols = colorRampPalette(stage_pal)
col.cell = stage_cols(length(unique_stages))

col.cell <- stage_cols(cores)[meta$tumor_stage[indices]]
color_mapping <- setNames(col.cell, unique_stages)

heatmap.2(highly_variable_lcpm[,indices], 
          col=rev(morecols(500)),
          trace="column", 
          main="Top 500 most variable genes across samples",
          ColSideColors=col.cell,
          scale="row"
          )

```
### Normalização

A normalização dos dados de RNA-seq desempenha um papel crucial no processo de análise realizado pelo edgeR. Por meio do método de Trimmed Means of M-values (TMM), as contagens de leitura são ajustadas levando em consideração a composição global das amostras, o que corrige variações introduzidas durante o sequenciamento. Ao aplicar a função `calcNormFactors()`, o edgeR calcula os fatores de normalização (escala) com base na técnica TMM, assegurando uma correção adequada das diferenças observadas entre as amostras.

O código fornecido ilustra a aplicação desse processo ao objeto de dados `dgeObj`. Em seguida, são gerados gráficos de diferença de média versus média (MD) para visualizar o efeito da normalização nos dados. Esses gráficos permitem avaliar se as variações biológicas são mantidas após o ajuste das contagens, destacando a ausência de diferenças médias entre as amostras como referência para a eficácia da normalização.

Quando as diferenças observadas nos gráficos de MD antes e depois da normalização por TMM são mínimas, isso sugere que o impacto da normalização nas contagens de leitura é insignificante. Isso pode indicar que as variações técnicas introduzidas durante o sequenciamento já eram baixas ou que as amostras possuíam uma composição homogênea.

Embora isso sugira estabilidade nos dados, é importante ressaltar que pequenas diferenças podem ter relevância biológica. Portanto, é necessário interpretar os resultados com cautela, considerando outros aspectos do experimento, como o contexto biológico e as condições experimentais, para compreender plenamente o significado das variações observadas.



```{r}
# Normalização

dgeObj = calcNormFactors(dgeObj)

# demo

plotMD(logcounts, column = 7)
abline(h=0,col="grey")

plotMD(dgeObj, column = 7)
abline(h=0,col="grey")
```

#### Análise de expressão diferencial e de enriquecimento

Para a identificação do conjunto de genes que têm diferentes níveis de expressão fez-se a comparação de.....

##### Contagem do número de condições

num_condicoes \<- length(unique(group))

condições experimentais.

-   Definição das variáveis de design

```{r}

# Limitar ao tumour stage (alterar se necessário)

#seqdata = seqdata[,!is.na(luad_data$paper_Tumor.stage)]

group = paste(luad_data$paper_Tumor.stage)

group = as.character(group)

# Filtrar os dados do grupo para remover NA correspondentes aos mesmos pacientes
group_clean = group[!is.na(luad_data$paper_Tumor.stage)]

# Definir a variável de design
design <- model.matrix(~ group_clean)

```

-   Estimação da dispersão

```{r}
dgeObj = estimateCommonDisp(dgeObj)

dgeObj

```

```{r}
dgeObj = estimateGLMTrendedDisp(dgeObj)

dgeObj

```

```{r}
dgeObj = estimateTagwiseDisp(dgeObj)

dgeObj
```

-   Fit do Modelo Linear

Foram efetuados quasi-likehood F-tests, são testes altamente recomendados para análises de expressão diferencial de dados de RNA-seq em massa, uma vez que permite um controlo mais rigoroso da taxa de erro, tendo em conta a incerteza na estimativa da dispersão.

```{r}

fit = glmFit(dgeObj, design)
names(fit)
head(coef(fit))

```

-   Teste de Razão de Verossimilhança

```{r}

lrt.BvsL <- glmLRT(fit, coef=2) 
topTags(lrt.BvsL)

```

-   Resultados e visualização destes

```{r}
results <- as.data.frame(topTags(lrt.BvsL,n = Inf))
results
dim(results)
summary(de <- decideTestsDGE(lrt.BvsL))
```

De seguida, criou-se um gráfico de dispersão dos valores de log fold-change em relação à média de contagens para cada gene, destacando os genes diferencialmente expressos identificados.

```{r}

detags <- rownames(dgeObj)[as.logical(de)]
plotSmear(lrt.BvsL, de.tags=detags)

```

Foi ainda criado um volcano plot onde os genes diferencialmente expressos identificados pelo teste são destacados em vermelho.

```{r}

signif <- -log10(results$FDR)
plot(results$logFC,signif,pch=16)
points(results[detags,"logFC"],-log10(results[detags,"FDR"]),pch=16,col="red")

```

#### Análise de Enriquecimento

A análise de enriquecimento é realizada sobre o conjunto de genes alvo, identificados por através da análise de expressão diferencial. O conjunto de genes identificados é comparado com outros conjuntos de genes, onde cada um destes contém genes biologicamente coerentes

```{r}

head(dgeObj$samples)
```
